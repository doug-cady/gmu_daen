---
title: "Human Freedom Index and Suicides Project"
subtitle: "Part 2: Data Exploration with Suicides Dataset"
author: "Doug Cady"
date: "November 6, 2021"
output:
    github_document:
        toc: true
---

```{r hidden, echo = FALSE}
# html_document:
#         toc: true
#         keep_md: true
#         theme: simplex
#         highlight: tango
#     pdf_document:
#         toc: true
```

R version 4.1.1 "Kick Things"

```{r packs, results = 'hide'}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(GGally)
library(gridExtra)
library(plotly)
```


## Load dataset into R

```{r data, results = 'hide', message = FALSE, warning = FALSE}
suicides <- read_csv("../data/suicide_rates.csv")
```


## Explore Suicides dataset
#### This is the initial dataset format when R loads it into its program, but we need to change the type of several of these to a factor (categorical) format.

```{r}
print(summary(suicides))
```

### Update format with factor and numeric variables, year >= 2008 to match HFI data
* 3 categorical variables
    + `country`
    + `sex`
    + `age`
* 4 numeric
    + `suicides`
    + `population`
    + `suicides per `100k`
    + `gdp per capita`
* 1 time-series
    + `year`

```{r}
age_levels <- c("5-14", "15-24", "25-34", "35-54", "55-74", "75+")

suic_fmt <- suicides %>%
    mutate(country = factor(country),
           year = year,
           sex = factor(sex),
           age = factor(str_replace(age, " years", ""), levels = age_levels),
           suicides_p100k = `suicides/100k pop`,
           gdp_per_capita = `gdp_per_capita ($)`) %>%
    select(country, year, sex, age, suicides_no, population, suicides_p100k, gdp_per_capita) %>%
    filter(year >= 2008)

write_csv(suic_fmt, "../data/clean_suicides.csv")

print(summary(suic_fmt))
```
#### Data Summary
- No NAs, thus no missing values
- Each of the 4 numeric variables have a heavy right skew (mean >> median):
    + We can see this more clearly visually with histograms (see next page)
    + Log transformations are required to see variable distributions


### Head / Tail of Data
Nothing out of the ordinary here. It seems like we read in the whole file and do not need to skip
any header or footer miscellaneous data.
```{r}
print(head(suic_fmt))
print(tail(suic_fmt))
```


### Further investigate high suicide counts
Sorting by suicide counts descending tells us that US and Russian men age 35-54 had the highest
suicide raw counts from 2008 - 2015, but this is not scaled by population yet.
If we instead look at suicides per 100k persons, will the same trend hold?
```{r}
high_suicides <- suic_fmt %>%
    filter(suicides_no > 1000) %>%
    arrange(desc(suicides_no)) %>%
    print()
```

#### Suicides per 100k persons
US and Russian men are no longer at the top of list, so it may have been due to their large population
that so many suicides occurred.  In both of these lists I see only male persons that are older
as well, so maybe sex or age plays a factor here.
```{r suicide_boxplot}
suic_fmt %>%
    arrange(desc(suicides_p100k)) %>%
    print()

# We can also look at the quantile breakdown for suicides per 100k persons:
quantile(suic_fmt$suicides_p100k, probs = seq(0, 1, 1/10))

# A boxplot can show us visually that the rates are pretty low except for some high outliers
boxplot(suic_fmt$suicides_p100k)

# What about all those 0 values? Do some countries have only 0 values for every record?
suic_cts_country <- suic_fmt %>%
    mutate(zero_suicides = if_else(suicides_no == 0, 1, 0)) %>%
    group_by(country, zero_suicides) %>%
    count() %>%
    pivot_wider(names_from = "zero_suicides", values_from = "n", names_prefix = "zero_suic_") %>%
    rename(rec_ct_suic_gt0 = zero_suic_0,
           rec_ct_suic_eq0 = zero_suic_1) %>%
    mutate(perc_zero_suic_recs = rec_ct_suic_eq0 / (rec_ct_suic_eq0 + rec_ct_suic_gt0)) %>%
    arrange(desc(perc_zero_suic_recs))

print(suic_cts_country)
write_csv(suic_cts_country, "../output/suicide_counts_country.csv")
```

#### Suicides per 100k persons vs Age by Sex
Does sex or age contribute to historic suicide rates?
Yes, it does seem like suicides are more common among men than women and elderly vs young folks,
though this plot contains 30 years of data for over 100 countries.
```{r suicides_age_sex}
ggplot(suic_fmt) +
    geom_jitter(aes(x = sex, y = suicides_p100k, color = sex),
                alpha = 0.2) +
    facet_grid( ~ age)
```


### Variable Distributions
I first tried a regular histogram for the variable `suicide_no`, but there is such a pronounced
right skew that applying a log to the x axis made sense.  I believe `population`,
`suicides per 100k`, and `gdp per capita` might have a similar problem in viewing their
distributions with no transformations applied.

I created a log histogram and density plot function to help in making these 4 plots. The `get()`
function can give ggplot the correct column name from an input "string" column name. If I was
using Python, I would have created a dictionary and looped over it to get the column and axis
labels, but R makes this process harder.

```{r var_dist, message = FALSE, warning = FALSE}
make_hist <- function(xlab, col) {
    ggplot(suic_fmt) +
        geom_histogram(aes(x = log(get(col)), y = ..density..)) +
        geom_density(aes(x = log(get(col)))) +
        labs(x = xlab, y = "Frequency")
}

h1 <- make_hist(xlab = "log(Suicides)", col = "suicides_no")
h2 <- make_hist(xlab = "log(Population)", col = "population")
h3 <- make_hist(xlab = "log(Suicides_Per100k)", col = "suicides_p100k")
h4 <- make_hist(xlab = "log(GDP_Per_Capita)", col = "gdp_per_capita")

grid.arrange(h1, h2, h3, h4, ncol = 2)
```


### Time-series trends
Lastly, I would like to take a look at the `year` variable to see if there is any time-series
trends at play.

```{r timeseries_fig, fig.height = 7, fig.width = 10, message = FALSE}
suic_totals <- suic_fmt %>%
    select(year, country, suicides_no, population) %>%
    group_by(year, country) %>%
    summarize(total_suicides = sum(suicides_no),
              total_pop = sum(population),
              total_suicides_p100k = total_suicides / total_pop * 100000)

# We are missing data from some years for some countries
# Show table of year, country, suicide rates
# pivot_longer(suic_totals, year,

ggp_time <- ggplotly(ggplot(suic_totals) +
    geom_line(aes(x = year, y = total_suicides_p100k, color = country, group = country),
              alpha = 0.3, show.legend = FALSE))
```

```{r add_ggplotly, echo = FALSE}
htmlwidgets::saveWidget(ggp_time, "index.html")

htmltools::tags$iframe(
    src = file.path(getwd(), "index.html"),
    width = "100%",
    height = "600",
    scrolling = "no",
    seamless = "seamless",
    frameBorder = "0"
)
```
